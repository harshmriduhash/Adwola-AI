# AmplifyAI: Database Schema

This is the definitive SQL schema for the project, to be managed via Supabase Migrations.

## File: `supabase/migrations/V1_initial_schema.sql`

```sql
-- 1. USERS TABLE
-- Stores public user data, synced from Clerk.
CREATE TABLE public.users (
  id uuid NOT NULL PRIMARY KEY, -- References auth.users.id
  full_name text,
  avatar_url text
);

-- 2. BRANDS TABLE
-- Stores brand-specific guidelines for AI generation.
CREATE TABLE public.brands (
  id uuid NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id uuid NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  created_at timestamptz DEFAULT now(),
  brand_name text NOT NULL,
  brand_description text,
  tone_of_voice text,
  logo_url text
);

-- 3. CONTENT BRIEFS TABLE
-- The initial user input that kicks off a campaign.
CREATE TABLE public.content_briefs (
  id uuid NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id uuid NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  brand_id uuid NOT NULL REFERENCES public.brands(id) ON DELETE CASCADE,
  created_at timestamptz DEFAULT now(),
  topic text NOT NULL,
  goal text,
  cta_text text,
  status text DEFAULT 'pending' NOT NULL -- pending, processing, completed, error
);

-- 4. GENERATED POSTS TABLE
-- Stores each individual piece of AI-generated content.
CREATE TABLE public.generated_posts (
  id uuid NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  brief_id uuid NOT NULL REFERENCES public.content_briefs(id) ON DELETE CASCADE,
  platform text NOT NULL, -- e.g., 'LinkedIn', 'Twitter'
  generated_text text,
  generated_media_urls jsonb,
  status text DEFAULT 'draft' NOT NULL, -- draft, approved, scheduled, posted, error
  schedule_time timestamptz,
  post_url text -- The URL of the live post after publishing
);

-- 5. WAITLIST TABLE
-- For the initial landing page.
CREATE TABLE public.waitlist_emails (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  email text NOT NULL UNIQUE,
  created_at timestamptz DEFAULT now()
);

----------------------------------------------------
-- CLERK-SUPABASE SYNC FUNCTION & TRIGGER
----------------------------------------------------
-- This function automatically creates a user profile when a new user signs up via Clerk.
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger AS $$
BEGIN
  INSERT INTO public.users (id, full_name, avatar_url)
  VALUES (new.id, new.raw_user_meta_data->>'full_name', new.raw_user_meta_data->>'avatar_url');
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- This trigger calls the function after a new user is inserted into auth.users.
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();

----------------------------------------------------
-- ROW LEVEL SECURITY (RLS) POLICIES
----------------------------------------------------
-- Enable RLS on all tables
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.brands ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.content_briefs ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.generated_posts ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.waitlist_emails ENABLE ROW LEVEL SECURITY;

-- Policies for USERS
CREATE POLICY "Public profiles are viewable by everyone." ON public.users FOR SELECT USING (true);
CREATE POLICY "Users can insert their own profile." ON public.users FOR INSERT WITH CHECK (auth.uid() = id);
CREATE POLICY "Users can update their own profile." ON public.users FOR UPDATE USING (auth.uid() = id);

-- Policies for BRANDS
CREATE POLICY "Users can CRUD their own brands." ON public.brands
  FOR ALL USING (auth.uid() = user_id);

-- Policies for CONTENT BRIEFS
CREATE POLICY "Users can CRUD their own briefs." ON public.content_briefs
  FOR ALL USING (auth.uid() = user_id);

-- Policies for GENERATED POSTS (ownership is derived from the brief)
CREATE POLICY "Users can view posts from their own briefs." ON public.generated_posts
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM content_briefs
      WHERE content_briefs.id = generated_posts.brief_id AND content_briefs.user_id = auth.uid()
    )
  );
CREATE POLICY "Users can update posts from their own briefs." ON public.generated_posts
  FOR UPDATE USING (
    EXISTS (
      SELECT 1 FROM content_briefs
      WHERE content_briefs.id = generated_posts.brief_id AND content_briefs.user_id = auth.uid()
    )
  );

-- Policies for WAITLIST
CREATE POLICY "Anyone can sign up for the waitlist." ON public.waitlist_emails
  FOR INSERT WITH CHECK (true);

```
